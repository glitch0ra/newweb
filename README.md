# Медиа-галерея

Одностраничное веб-приложение (SPA) для демонстрации авторских медиа-работ с современным дизайном в стиле Liquid Glass и Anti-Design.

## Структура проекта

```
newweb/
├── index.html              # Главный HTML файл
├── config.json             # Конфигурация приложения (загружается первой)
├── css/
│   ├── styles-critical.css # Критичные стили для первого экрана (above-the-fold)
│   └── styles.css          # Все остальные стили (Liquid Glass + Anti-Design)
├── js/
│   ├── app.js              # Главный класс Application (единая точка входа)
│   ├── router.js           # Роутинг SPA (hash-based)
│   ├── data-loader.js      # Загрузка и кэширование JSON данных
│   ├── config/
│   │   └── constants.js   # Централизованные константы (магические числа)
│   ├── core/
│   │   └── page.js         # Базовый класс для всех страниц
│   ├── components/
│   │   ├── modal.js        # Модальные окна с поддержкой стека и ARIA
│   │   └── carousel.js     # Карусели с drag/swipe и доступностью
│   ├── pages/
│   │   ├── main.js         # Вкладка "Главная"
│   │   ├── collections.js  # Вкладка "Коллекции"
│   │   ├── screenshots.js  # Вкладка "Скриншоты" (с виртуализацией)
│   │   ├── videos.js       # Вкладка "Видео" (с виртуализацией)
│   │   ├── history.js      # Вкладка "История"
│   │   └── about.js        # Вкладка "Об авторе"
│   └── utils/
│       ├── store.js            # Централизованное хранилище состояния (memory + sessionStorage)
│       ├── event-bus.js        # Event-driven архитектура
│       ├── data-validator.js   # Валидация JSON данных
│       ├── image-handler.js    # Обработка изображений
│       ├── loader-animation.js # Анимация загрузки
│       ├── parallax.js         # Параллакс эффекты
│       ├── preloader.js        # Прелоадер с оптимизацией
│       └── virtualized-grid.js # Виртуализация сеток с IntersectionObserver
├── data/
│   ├── main.json           # Данные для главной страницы
│   ├── collections.json    # Данные коллекций
│   ├── screenshots.json    # Данные скриншотов
│   ├── videos.json         # Данные видео
│   ├── history.json        # Данные истории
│   └── about.json          # Данные об авторе
└── assets/
    ├── background.webm     # Фоновое видео
    └── header.webm         # Видео для шапки
```

## Технологии

- **HTML5** - Семантическая разметка с ARIA атрибутами
- **Vanilla JavaScript (ES6+)** - Без фреймворков, чистый JS
- **CSS3** - Flexbox, Grid, Custom Properties, Animations, Backdrop Filter, Scroll Snap
- **JSON** - Хранение данных с валидацией
- **WebM** - Видео формат для фона и шапки
- **sessionStorage** - Персистентное кэширование данных
- **IntersectionObserver API** - Эффективная виртуализация больших списков
- **Background Sync API** - Асинхронная предзагрузка медиа без блокировки UI
- **requestAnimationFrame** - Оптимизированные анимации
- **CSS Scroll Snap** - Нативная поддержка прокрутки в каруселях

## Архитектура

### Application Class
Единая точка входа приложения, которая инициализирует и управляет всеми компонентами:
- **Store** - централизованное хранилище состояния (memory + sessionStorage)
- **EventBus** - система событий для декомпозиции зависимостей
- **DataLoader** - загрузка и кэширование данных
- **DataValidator** - валидация JSON данных
- **Preloader** - оптимизированная предзагрузка медиа
- **Modal** - управление модальными окнами
- **LoaderAnimation** - анимация загрузки
- **Router** - навигация по маршрутам
- **Pages** - все страницы приложения

Приложение использует Dependency Injection паттерн - все зависимости передаются через конструкторы компонентов, что обеспечивает:
- Инкапсуляцию и тестируемость
- Возможность создания нескольких независимых экземпляров
- Явные зависимости вместо скрытых через глобальные переменные

### Прямые зависимости вместо Event Bus
Приложение использует прямые вызовы методов вместо Event Bus для связи Application <-> Pages:
- `Application` напрямую вызывает `page.load()` при навигации
- Зависимости явные, не скрытые через события
- Упрощенная архитектура без мнимой декомпозиции
- Устранение циклических зависимостей через явную передачу зависимостей
- Event Bus может использоваться для других целей, но не для связи Application <-> Pages

### State Management (Store)
Централизованное хранилище состояния для кэширования данных страниц:
- Данные сохраняются в памяти при первой загрузке
- Персистентное кэширование через `sessionStorage`
- Данные сохраняются при перезагрузке страницы
- Переиспользуются при повторных переходах
- Ускоряет навигацию между страницами
- **Управление памятью**: LRU (Least Recently Used) механизм для предотвращения переполнения
- **Автоматическая очистка**: Удаляет самые старые данные при превышении лимита (5MB по умолчанию)
- **Защита от QuotaExceededError**: Автоматически освобождает место при ошибках переполнения
- **Автоматическое обновление устаревших данных**: Проверяет время последней загрузки (`lastLoadTime`) и автоматически обновляет данные старше `cacheMaxAge` (по умолчанию 1 час)
- **Принудительное обновление**: Поддержка `forceReload` для обхода кэша и загрузки свежих данных
- Методы: `get(route)`, `set(route, data)`, `has(route)`, `clear(route)`, `evictOldest(requiredSpace)`

## Особенности

### Дизайн
- **Liquid Glass дизайн**: Прозрачные элементы с размытием фона (backdrop-filter)
- **Anti-Design**: Асимметрия, glitch-эффекты, визуальный шум
- **Видео фон**: Фоновое видео на всей странице
- **Видео шапка**: Видео в шапке сайта (1400px × 430px)
- **Адаптивный дизайн**: Поддержка mobile, tablet, desktop
- **Критичные стили**: Инлайн критичные стили в HTML для устранения render-blocking запросов (предотвращение FOUC)

### Функциональность
- **SPA навигация**: Переключение между вкладками без перезагрузки страницы
- **Кэширование состояния**: Данные сохраняются в Store (memory + sessionStorage)
- **Прелоадер первого экрана**: Инлайн прелоадер предотвращает белый экран
- **Модальные окна**: 
  - Полноэкранный просмотр медиа-контента
  - Стек модальных окон (pushContent/popContent) для вложенных окон
  - Кнопка "Назад" для возврата к предыдущему модальному окну
  - Навигация клавиатурой (← →, ESC)
  - **ARIA поддержка**: `aria-hidden`, `aria-modal`, focus trap для доступности
- **Карусели**: 
  - Горизонтальная прокрутка с drag/swipe поддержкой
  - Навигация стрелками
  - Адаптивное количество элементов на экране
  - **Нативная прокрутка**: CSS Scroll Snap для интуитивной прокрутки
  - **Оптимизация производительности**: Кэширование размеров, CSS Custom Properties
  - **ARIA поддержка**: `aria-live`, `aria-current` для screen readers
  - **Screen reader announcements**: Динамические объявления текущего слайда с информацией о содержимом
- **Виртуализация**: 
  - Разбивка больших списков на страницы (18 элементов на страницу)
  - **IntersectionObserver**: Рендеринг только видимых элементов в сетках (VirtualizedGrid)
  - Оптимизация производительности для больших коллекций
- **Ленивая загрузка**: Нативная оптимизация загрузки изображений (`loading="lazy"`)
- **Параллакс эффекты**: Прокрутка фонового видео
- **Прелоадер**: Оптимизированная анимация загрузки с `requestAnimationFrame` и `transitionend`
- **Background Sync API**: Асинхронная предзагрузка медиа без блокировки UI (с fallback на `requestIdleCallback`)

### Безопасность
- **XSS защита**: Автоматическое экранирование HTML, атрибутов и URL
  - `escapeHTML()`: Экранирование HTML-сущностей
  - `escapeAttribute()`: Экранирование атрибутов HTML
  - `escapeURL()`: Валидация URL с проверкой протоколов (только `http:`, `https:`, `mailto:`, `tel:`)
- **Валидация данных**: Проверка структуры JSON перед использованием
- **Безопасные шаблоны**: Метод `template()` с приватным Symbol `Page.SAFE_TEMPLATE` для явного разрешения HTML (защита от инъекции опций через внешние параметры)
- **Глобальная обработка ошибок**: Обработчики `unhandledrejection` и `error` событий
- **Валидация в модальных окнах**: Все данные валидируются перед отображением
- **Null checks**: Проверки на null/undefined в критических местах для предотвращения ошибок

### Производительность
- **Кэширование данных**: Store предотвращает повторные загрузки
- **sessionStorage кэширование**: Данные сохраняются при перезагрузке страницы
- **Оптимизация reflow**: Кэширование размеров элементов, использование CSS Custom Properties
- **Виртуализация списков**: Рендеринг только видимых элементов
- **Оптимизированный preloader**: Использование `requestAnimationFrame` вместо `setTimeout`
- **Управление памятью**: Автоматическая очистка event listeners и observers
- **Асинхронная загрузка скриптов**: Использование `defer` для всех скриптов
- **Критичные стили**: Отдельный файл для первого экрана
- **Полифилл performance.now()**: Совместимость с Safari 14

### Доступность (A11y)
- **ARIA атрибуты**: Полная поддержка для screen readers
- **Focus management**: 
  - Trapping фокуса в модальных окнах
  - Автоматическое перемещение фокуса на `main-content` при навигации между страницами
  - Возврат фокуса к элементу, открывшему модальное окно, при закрытии
- **Keyboard navigation**: Полная навигация с клавиатуры
- **Screen reader announcements**: Объявления о загрузке и навигации через `aria-live` регион
- **ARIA live регион**: Обновляется при навигации между страницами
- **ARIA hidden**: Элементы вне модального окна скрыты от screen readers
- **Семантические заголовки**: Использование `<h1>` для главных заголовков в модальных окнах (вместо `<h2>`)
- **Carousel accessibility**: Динамические объявления текущего слайда с информацией о содержимом (title, alt, text content)

### Вкладки

#### Главная (main.js)
- Приветственный экран с описанием проекта
- Ленивая загрузка изображений

#### Коллекции (collections.js)
- Карусели с изображениями коллекций
- Модальные окна с детальной информацией:
  - Главное изображение (2:3 aspect ratio)
  - Видео (16:9 aspect ratio)
  - Скриншоты (16:9 aspect ratio)
  - Вложенные модальные окна для просмотра скриншотов и видео
  - Кнопка "Назад" для возврата к основному модальному окну

#### Скриншоты (screenshots.js)
- Группы скриншотов с виртуализацией (пагинация)
- Модальные окна для просмотра с навигацией
- Кнопка закрытия модального окна

#### Видео (videos.js)
- Группы видео с виртуализацией (пагинация)
- Модальные окна для просмотра видео
- Навигация между видео стрелками или клавиатурой
- Кнопка закрытия модального окна

#### История (history.js)
- Хронология работ с каруселями изображений
- Стрелки навигации вынесены за пределы карусели

#### Об авторе (about.js)
- Информация об авторе проекта

## Установка

1. Клонируйте репозиторий или скачайте файлы проекта

2. Добавьте видео файлы в папку `assets/`:
   - `background.webm` - фоновое видео (отображается на всю страницу)
   - `header.webm` - видео для шапки (1400px × 430px)

3. Обновите JSON файлы в папке `data/` своими данными:
   - `main.json` - данные для главной страницы
   - `collections.json` - данные коллекций (изображения, видео, скриншоты)
   - `screenshots.json` - данные скриншотов
   - `videos.json` - данные видео
   - `history.json` - данные истории
   - `about.json` - данные об авторе

4. Запустите локальный сервер (например, `python -m http.server 8000`)

5. Откройте `http://localhost:8000` в браузере

## Использование

### Навигация
- Навигация между вкладками через меню в шапке
- Клик по любому медиа-блоку открывает модальное окно
- ESC или клик вне модального окна закрывает его
- Данные кэшируются в Store (memory + sessionStorage) для быстрой повторной навигации

### Модальные окна
- **В коллекциях**: 
  - Клик по изображению открывает модальное окно с деталями
  - Клик по скриншоту открывает вложенное модальное окно с кнопкой "Назад"
  - Клик по видео открывает вложенное модальное окно с кнопкой "Назад"
- **В скриншотах/видео**: 
  - Клик по элементу открывает модальное окно для просмотра
  - Навигация стрелками или клавишами ← →
  - Кнопка закрытия в правом верхнем углу
- **Доступность**: 
  - Фокус блокируется внутри модального окна
  - Screen readers объявляют открытие/закрытие
  - Навигация с клавиатуры полностью поддерживается

### Карусели
- Перетаскивание мышью (drag)
- Свайп на мобильных устройствах
- Навигация стрелками по бокам
- Автоматическая адаптация количества элементов на экране
- Оптимизированная производительность (кэширование размеров)

### Пагинация
- В скриншотах и видео: кнопки пагинации для переключения страниц
- 18 элементов на страницу (3 ряда × 6 колонок)
- Виртуализация: рендеринг только видимых страниц

## Структура данных

Все JSON файлы валидируются перед использованием. Структура должна соответствовать ожидаемому формату.

### collections.json
```json
{
  "collections": [
    {
      "id": "1",
      "title": "Название коллекции",
      "date": "2024-12-15",
      "description": "Описание",
      "images": [
        {
          "id": "1",
          "url": "url",
          "title": "Название",
          "description": "Описание",
          "videos": [...],
          "screenshots": [...],
          "downloadLink": "url"
        }
      ]
    }
  ]
}
```

### videos.json / screenshots.json
```json
{
  "groups": [
    {
      "id": "1",
      "title": "Название группы",
      "date": "2024-12-15",
      "description": "Описание",
      "videos": [...] // или "screenshots": [...]
    }
  ]
}
```

## Безопасность

### XSS Защита
- Все данные автоматически экранируются при вставке в HTML
- Методы `escapeHTML()`, `escapeAttribute()`, `escapeURL()` в базовом классе `Page`
- Явное разрешение HTML через приватный Symbol `Page.SAFE_TEMPLATE` в шаблонах (защита от инъекции опций)
- Возврат пустой строки вместо неэкранированного текста при отсутствии данных

### Валидация данных
- Все JSON файлы валидируются перед использованием
- Проверка типов данных и обязательных полей
- Предоставление значений по умолчанию для опциональных полей
- Логирование ошибок валидации
- Валидация данных в модальных окнах перед отображением

### Глобальная обработка ошибок
- Обработчик `unhandledrejection` для неотловленных Promise rejections
- Обработчик `error` для глобальных JavaScript ошибок
- Пользовательские сообщения об ошибках
- Автоматическое скрытие loader при ошибках
- Объявления для screen readers при ошибках

## Производительность

### Оптимизации
- **Store кэширование**: Данные загружаются один раз и переиспользуются
- **sessionStorage кэширование**: Данные сохраняются при перезагрузке страницы
- **LRU управление памятью**: Автоматическое удаление старых данных при превышении лимита (5MB)
- **Виртуализация**: Рендеринг только видимых элементов в больших списках
- **Кэширование размеров**: Предотвращение forced reflow в каруселях
- **CSS Custom Properties**: Использование для чтения значений без reflow
- **Оптимизированный preloader**: `requestAnimationFrame` вместо `setTimeout`
- **Нативная ленивая загрузка**: Использование `loading="lazy"` для изображений
- **Асинхронная загрузка скриптов**: Использование `defer` для всех скриптов
- **Критичные стили**: Отдельный файл для первого экрана (предотвращение FOUC)
- **Прелоадер первого экрана**: Инлайн прелоадер предотвращает белый экран

### Управление памятью
- Автоматическая очистка event listeners при навигации
- Удаление observers (IntersectionObserver) при cleanup
- Очистка модальных окон и каруселей
- Отписка от EventBus при навигации
- Правильное удаление passive event listeners в Safari
- **Очистка модальных окон**: 
  - Клонирование `modalContent` для удаления всех event listeners
  - Очистка `onCloseCallbacks` при закрытии модального окна
  - Удаление старых keyboard handlers перед установкой новых
- **Виртуализация**: Правильная очистка `IntersectionObserver` при уничтожении `VirtualizedGrid`
- **Очистка модальных окон**: 
  - Клонирование `modalContent` для удаления всех event listeners
  - Очистка `onCloseCallbacks` при закрытии модального окна
  - Удаление старых keyboard handlers перед установкой новых
- **Виртуализация**: Правильная очистка `IntersectionObserver` при уничтожении `VirtualizedGrid`

### Порядок загрузки скриптов
Скрипты загружаются в правильном порядке с учетом зависимостей:
1. Утилиты (независимые классы)
2. Компоненты (независимые классы)
3. Core классы (базовые классы)
4. DataLoader (зависит от утилит)
5. Страницы (зависят от Page)
6. Router (создается в app.js)
7. Application (использует все классы)

Все скрипты используют атрибут `defer` для асинхронной загрузки без блокировки парсинга HTML.

## Доступность (A11y)

### ARIA поддержка
- `aria-hidden` для элементов вне модального окна
- `aria-modal="true"` для модальных окон
- `aria-live="polite"` для объявлений screen reader
- `aria-current="true"` для активных элементов карусели
- `role="dialog"` для модальных окон
- `aria-labelledby` для модальных окон

### Keyboard Navigation
- Полная навигация с клавиатуры
- Focus trapping в модальных окнах
- Навигация стрелками в каруселях и модальных окнах
- ESC для закрытия модальных окон

### Screen Reader Support
- Объявления о загрузке страниц через `aria-live` регион
- Объявления о текущем слайде в каруселях
- Объявления о навигации между страницами
- Объявления об ошибках загрузки
- Правильное обновление `aria-live` региона при навигации

## Браузерная поддержка

- Chrome 90+
- Firefox 88+
- Safari 14+ (с полифиллом для `performance.now()`)
- Edge 90+

Требуется поддержка:
- CSS Backdrop Filter
- ES6+ JavaScript
- HTML5 Video
- CSS Grid и Flexbox
- CSS Custom Properties
- sessionStorage API

### Совместимость с Linux (GitHub Pages)
- Все имена файлов используют правильный регистр (case-sensitive)
- Все импорты соответствуют реальным именам файлов
- Совместимость с case-sensitive файловыми системами

## Разработка

### Архитектурные паттерны
- **Application Class**: Единая точка входа, инкапсуляция компонентов
- **Event Bus**: Декомпозиция зависимостей через события (не используется для Application <-> Pages связи)
- **Store Pattern**: Централизованное управление состоянием (memory + sessionStorage) с LRU кэшированием
- **Base Class Pattern**: Общая функциональность в `Page` классе
- **Dependency Injection**: Компоненты получают зависимости через конструктор (устранение глобального `window.app`)
- **DRY принцип**: Минимизация дублирования кода
- **Constants Pattern**: Централизация магических чисел в `constants.js` для лучшей поддерживаемости
- **Virtualization Pattern**: Использование `IntersectionObserver` для эффективного рендеринга больших списков

### Расширение функциональности
1. Добавьте новый route в `Store.state`
2. Создайте новый класс страницы, наследуя от `Page`
3. Реализуйте методы: `getRoute()`, `loadData()`, `renderContent()`
4. Зарегистрируйте страницу в `Application.pages` с передачей необходимых зависимостей через конструктор
5. Добавьте route в `Router` для навигации
6. При необходимости обновите конфигурацию в `config.json` (или добавьте fallback в `js/config/constants.js`)

### Оптимизация CSS
- **styles-critical.css**: Только критичные стили для первого экрана
- **styles.css**: Все остальные стили и CSS переменные
- Переменные `:root` определены только в `styles.css`
- Нет дублирования стилей между файлами

### Конфигурация (config.json)
Конфигурация приложения загружается из `config.json` синхронно перед всеми остальными скриптами, что гарантирует доступность `window.APP_CONFIG` для всех модулей.

Структура конфигурации:
- `PAGINATION`: Настройки пагинации (items per page, preview items, grid columns)
- `CAROUSEL`: Настройки каруселей (items per view, thresholds, delays)
- `PRELOADER`: Настройки предзагрузки (batch size)
- `VIRTUALIZATION`: Настройки виртуализации
- `ROUTES`: Конфигурация роутов приложения (path, title, dataPath)

Все константы доступны через `window.APP_CONFIG` для совместимости.

**Примечание**: `js/config/constants.js` содержит fallback значения для обратной совместимости, если `config.json` не загрузился.

## Лицензия

MIT
